<?php
/**
 * Magento
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Academic Free License (AFL 3.0)
 * that is bundled with this package in the file LICENSE_AFL.txt.
 * It is also available through the world-wide-web at this URL:
 * http://opensource.org/licenses/afl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magentocommerce.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magentocommerce.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright   Copyright (c) 2011 Magento Inc. (http://www.magentocommerce.com)
 * @license     http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
 */

/**
 * Product view template
 *
 * @see Mage_Catalog_Block_Product_View
 * @see Mage_Review_Block_Product_View
 */
$breadcrumbs = $this->getLayout()->getBlock('breadcrumbs');
$breadcrumbs->setNoReset(true);
?>
<?php $_helper = $this->helper('catalog/output'); ?>
<?php $_product = $this->getProduct();  ?>
<?php $_color = $_product->getAttributeText('color'); ?>
<?php $_material = $_product->getAttributeText('material'); ?>
<?php
$_colorId = $_product->getData('color');
$_materialId = $_product->getData('material');
?>
        
<script type="text/javascript">
    var optionsPrice = new Product.OptionsPrice(<?php echo $this->getJsonConfig() ?>);
</script>
<div class="product-view">
    <div class="product-essential">
    <form action="<?php echo $this->getSubmitUrl($_product) ?>" method="post" id="product_addtocart_form"<?php if($_product->getOptions()): ?> enctype="multipart/form-data"<?php endif; ?>>
        <div class="no-display">
            <input type="hidden" name="product" value="<?php echo $_product->getId() ?>" />
            <input type="hidden" name="related_product" id="related-products-field" value="" />
        </div>

        <div class="product-shop">
            
            <div class="p-black p-box p-price p-product-name">
                <div class="product-name">
                    <h1><?php echo  $_helper->productAttribute($_product, $_product->getSku(), 'sku');?> <br/>
                        <?php echo $_helper->productAttribute($_product, $_product->getName(), 'name') ?><br>
                    </h1>
                    <span class="short-description">
                        <?php echo $_helper->productAttribute($_product, $_product->getShortDescription(), 'short_description'); ?>
                    </span>
                </div>
            </div>
                
            <div class="p-white p-box product-detail">
                <?php echo $this->__("DETAIL");?>
            </div>
            
            <div class="p-trasparency p-box product-detail-body ">                
                <div class="description">
                <?php echo $_helper->productAttribute($_product, $_product->getDescription(), 'description'); ?>
                </div>
                <?php echo $this->getLayout()
                            ->createBlock('catalog/product_view_attributes')
                            ->setTemplate('catalog/product/view/attributes.phtml')
                            ->toHtml();  ?>
                <br>
                <?php if ($_color): ?>                
                <div class="attribute-data ">            
                <?php echo $this->__('Color:');?> &nbsp;
                    <a mps-type="async-link" href="<?php echo Mage::getBaseUrl() ."catalogsearch/advanced/result/?color=$_colorId" ?>">
                        <?php echo $_color;?>
                    </a>
                </div>
                <?php endif; ?>
                <?php if ($_material ): ?>
                <div class="attribute-data">            
                    <?php echo $this->__('Material:');?> &nbsp;
                    <a mps-type="async-link" href="<?php echo Mage::getBaseUrl() ."catalogsearch/advanced/result/?material=$_materialId" ?>">
                        <?php echo $_material;?>
                    </a>
                </div>
                
                <?php endif; ?>
            </div>
            
            
            <?php //definire eventuale controllo per prodotto configurabile
                   // if ($_product->getTypeId() != Mage_Catalog_Model_Product_Type_Configurable::TYPE_CODE):
                   //endif;
            ?>

        </div>

        <div class="product-shop f-right">
            <div class="p-black p-box p-price">
                <?php echo $this->getLayout()
                            ->createBlock('catalog/product_view')
                            ->setTemplate('catalog/product/view/price_clone.phtml')
                            ->toHtml();  ?>
                <?php echo $this->getLayout()
                                ->createBlock('core/template')
                                ->setTemplate('corto/directory/exchange.rate.phtml')
                                ->toHtml() ?>
            </div>
            
            <?php if($_product->isSaleable()): ?>
            <div class="p-white p-box p-cart" style="position: relative">
                <?php echo $this->getChildHtml('addtocart'); ?>
            </div>
            <?php endif;?>
            <?php if( $this->helper('wishlist')->isAllow()):?>
            <div class="p-black p-box p-button">
                <?php $_wishlistSubmitUrl = $this->helper('wishlist')->getAddUrl($_product); ?>
                <a href="<?php echo $_wishlistSubmitUrl ?>" onclick="productAddToCartForm.submitLight(this, this.href); return false;" class="link-wishlist"><?php echo $this->__('Add to Wishlist') ?></a>
            </div>
            <?php endif;?>
            
            <div class="p-turquoise p-box p-button">
                <a href="<?php echo $this->getUrl('contacts');?>" 
                       title="<?php echo $this->__("Live Help"); ?>"
                       class="contact-us">
                    <?php echo $this->__('Need Help?');?>
                </a>
                <a href="<?php echo $this->getUrl('contacts');?>" title="<?php echo $this->__("Live Help"); ?>" class="contact-us contact-us-img">
                    <img src="<?php echo $this->getSkinUrl("images/ico_help_min.png");?>" alt="<?php echo $this->__("Live Help"); ?>"
                                 title="<?php echo $this->__("Live Help"); ?>"/>
                </a>
            </div>
            
            <?php if ($_product->getData('c_style_fortune_cookie') == ""): 
                echo $this->getLayout()
                                ->createBlock('catalog/product_view_media')
                                ->setTemplate('catalog/product/view/more-views.phtml')
                                ->toHtml();  
            endif;?>
        </div>
        
        <div class="product-img-box">
            <?php 
//foreach ( $this->_children as $k => $v) {
//    
//    echo "$k -> " . get_class($v) . "<br>";
//    
//}
//die();
            echo $breadcrumbs->toHtml();
            echo $this->getChildHtml('media');?>
        </div>
        
    </form>
    <script type="text/javascript" src="<?php echo $this->getSkinUrl('js/jwplayer.js') ?>"></script>    
    <script type="text/javascript">           
    //<![CDATA[
    
        var productAddToCartForm = new VarienForm('product_addtocart_form');
        productAddToCartForm.submit = function(button, url) {
            if (this.validator.validate()) {
                var form = this.form;
                var oldUrl = form.action;

                if (url) {
                   form.action = url;
                }
                var e = null;
                try {
                    jQuery.fn.layer(true,{waiting:"<?php echo $this->getSkinUrl('images/waiting.gif');?>", bindEsc:false});
                    //var timer = jQuery("#add-to-cart img").RainbowLink("background-color", true);
                    url = form.action;                    
                    jQuery.ajax({
                        url: url,
                        dataType: 'json',
                        type : 'post',
                        data: { "ajax":1},
                        success: function(data){                            
                            if (jQuery(".light").length>0 && typeof(data.lightCart)!="undefined") jQuery(".light").replaceWith(data.lightCart); 
                            if(jQuery('.header .links').length>0 && typeof(data.topLink)!="undefined") {
                            	jQuery('.links').each(function() {
                            		if (jQuery(this).attr("class").split(" ").length==1) {
                            			jQuery(this).replaceWith(data.topLink);
                            			return false;
                            		}                            		
                            	})
                            }
                            try {
                                jQuery.fn.initializeLightCart();
                                jQuery.fn.initializePopUpMenu();
                            } catch(e) {}
                            jQuery('.top-link-cart').headerSwitcher('R');
                            jQuery.fn.layer(false);                            
                                                        
                            animate(function () {
                                jQuery(".top-link-cart").trigger("click");
                            });
                            //clearInterval(timer);
                            jQuery("#add-to-cart img").css({ "background-color": "white"});
                        },
                        error: function (data) {
                            jQuery.fn.layer(false);
                            alert('<?php echo $this->__("We\'re sorry, but at this moment it is not possible to add the product to your Shopping Bag");?>');
                        }

                    });
                } catch (e) {
                }
                this.form.action = oldUrl;
                if (e) {
                    throw e;
                }

                if (button && button != 'undefined') {
                    button.disabled = true;
                }
            }
        }.bind(productAddToCartForm);

        productAddToCartForm.submitLight = function(button, url){
            if(this.validator) {
                var nv = Validation.methods;
                delete Validation.methods['required-entry'];
                delete Validation.methods['validate-one-required'];
                delete Validation.methods['validate-one-required-by-name'];
                if (this.validator.validate()) {
                    if (url) {
                        this.form.action = url;
                    }
                    this.form.submit();
                }
                Object.extend(Validation.methods, nv);
            }
        }.bind(productAddToCartForm);
    //]]>
   
      $j(window).load(function() {            
        
        $j(".contact-us").fancybox({
            autoScale   : true,
            padding     : "0",
            margin      : "0",
            showCloseButton : false,          
            onComplete: function () {
                $j.fn.fancyTitle("<?php echo $this->__('Contact Us');?>");
            }  
        });

                        
        //$j.fn.setBackGroundPage();
        jQuery(window).trigger('resize');
        
        jQuery("document").ready(function() {
        //Calcolo altezza ...
        $j('.product-view .product-img-box').height($j('.product-view .product-img-box').height() + $j('.product-view .product-img-box .breadcrumbs').outerHeight(true) );
        jQuery(".product-detail-body").height($j('.product-view .product-img-box').outerHeight()  - $j('.p-product-name').outerHeight() - $j('.product-detail').outerHeight()-4);
        jQuery(".product-detail-body").jScrollPane();
        });

        
<?php 
if (Mage::getSingleton("customer/session")->getAddProductToCart() == 1): 
            Mage::getSingleton("customer/session")->unsAddProductToCart()?>
        $j(".top-link-cart").trigger("click");
<?php endif;?>
      });

var V = {
    rotate: function(p, degrees) {
      var radians = degrees * Math.PI / 180,
        c = Math.cos(radians),
        s = Math.sin(radians);
      return [c*p[0] - s*p[1], s*p[0] + c*p[1]];
    },
    scale: function(p, n) {
      return [n*p[0], n*p[1]];
    },
    add: function(a, b) {
      return [a[0]+b[0], a[1]+b[1]];
    },
    minus: function(a, b) {
      return [a[0]-b[0], a[1]-b[1]];
    }
  };
  
function bezier( params, rotate ) {
    params.start = jQuery.extend( {angle: 0, length: 0.3333}, params.start );
    params.end = jQuery.extend( {angle: 0, length: 0.3333}, params.end );
 
    this.p1 = [params.start.x, params.start.y];
    this.p4 = [params.end.x, params.end.y];
 
    var v14 = V.minus( this.p4, this.p1 ),
      v12 = V.scale( v14, params.start.length ),
      v41 = V.scale( v14, -1 ),
      v43 = V.scale( v41, params.end.length );
 
    v12 = V.rotate( v12, params.start.angle );
    this.p2 = V.add( this.p1, v12 );
 
    v43 = V.rotate(v43, params.end.angle );
    this.p3 = V.add( this.p4, v43 );
 
    this.f1 = function(t) { return (t*t*t); };
    this.f2 = function(t) { return (3*t*t*(1-t)); };
    this.f3 = function(t) { return (3*t*(1-t)*(1-t)); };
    this.f4 = function(t) { return ((1-t)*(1-t)*(1-t)); };
 
    /* p from 0 to 1 */
    this.css = function(p) {
      var f1 = this.f1(p), f2 = this.f2(p), f3 = this.f3(p), f4=this.f4(p), css = {};
      if (rotate) {
        css.prevX = this.x;
        css.prevY = this.y;
      }
      css.x = this.x = ( this.p1[0]*f1 + this.p2[0]*f2 +this.p3[0]*f3 + this.p4[0]*f4 +.5 )|0;
      css.y = this.y = ( this.p1[1]*f1 + this.p2[1]*f2 +this.p3[1]*f3 + this.p4[1]*f4 +.5 )|0;
      css.left = css.x + "px";
      css.top = css.y + "px";
      return css;
    };
  };
  
  function animate(callback) {

    jQuery("#cart-animation").show();
    
console.log(jQuery('div.add-to-cart').offset());
console.log(jQuery('a.top-link-cart').offset());
    var path = {
      start: {
        x: 0,
        y: 0,
        angle: 190.012,
        length: 0.1
      },
      end: {
        x: jQuery('a.top-link-cart').offset().left - jQuery('div.add-to-cart').offset().left,
        y: jQuery('a.top-link-cart').offset().top - jQuery('div.add-to-cart').offset().top,
        angle: 90.012,
        length: 0.1
      }
    };

    var p = new bezier(path);
    console.log(p.css(p));
    jQuery('#cart-animation').css({'position': 'absolute', 'top' : p.p1[0]+'px', 'left' : p.p1[1]});
    jQuery('#cart-animation').animate({
        left: p.p2[0]+'px',
        top : p.p2[1]+'px'
    }, 500, function() {
        jQuery('#cart-animation').animate({
            left: p.p3[0]+'px',
            top : p.p3[1]+'px'
        }, 1000, function() {
            jQuery('#cart-animation').animate({
                left: p.p4[0]+'px',
                top : p.p4[1]+'px'
            }, 500, function() {
                jQuery("#cart-animation").fadeOut(500);
                callback();
            });
        });
    });

  };

    </script>
    </div>
    
</div>

<div class="clearer product-shop-divider"></div>   

<div class="product-view-bottom">
    <div class="product-collateral">        
        <?php echo $this->getChildHtml('upsell_products');  ?>
    </div>
    <div class="product-img-box">
        <?php if ($_product->getData('c_style_fortune_cookie') != ""): ?>
        <div class="p-black">
            <div class="description">                
                <?php  echo $_helper->productAttribute($_product, $_product->getData('c_style_fortune_cookie'), 'c_style_fortune_cookie'); ?>
                
            </div>
        </div>
        <?php endif;?>
    </div>
    <div class="product-shop f-right">
        <?php if ($_product->getData('c_style_fortune_cookie') != ""): 
                echo $this->getLayout()
                                ->createBlock('catalog/product_view_media')
                                ->setTemplate('catalog/product/view/more-views.phtml')
                                ->toHtml();  
            endif;?>
    </div>    
</div>

